<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../arc-definitions/arc-definitions.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="api-headers-form-item.html">

<dom-module id="api-headers-form">
  <template>
    <style>
    :host {
      display: block;
      @apply --raml-headers-form;
    }

    .form-item {
      @apply --layout-horizontal;
      @apply --layout-start;
    }

    api-headers-form-item {
      @apply --layout-flex;
    }

    .delete-icon {
      margin-top: 16px;
      color: var(--from-row-action-icon-color, var(--icon-button-color, rgba(0, 0, 0, 0.74)));
      transition: color 0.2s linear;
    }

    .delete-icon:hover {
      color: var(--from-row-action-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }

    .enable-checkbox {
      margin-top: 32px;
      margin-right: 8px;
    }

    .action-button {
      color: var(--raml-headers-form-action-button-color, var(--secondary-button-color, var(--accent-color)));
      background: var(--raml-headers-form-action-button-background, var(--secondary-button-background, #fff));
      @apply --secondary-button;
      @apply --raml-headers-form-action-button;
    }

    .action-button:hover {
      color: var(--raml-headers-form-action-button-color-hover, var(--secondary-button-color, var(--accent-color)));
      background: var(--raml-headers-form-action-button-background-hover, var(--secondary-button-background, #fff));
      @apply --secondary-button-hover;
      @apply --raml-headers-form-action-button-hover;
    }

    .action-icon {
      margin-right: 8px;
      color: var(--raml-headers-form-action-icon-color, var(--secondary-button-color, var(--accent-color)));
      opacity: var(--raml-headers-form-action-icon-opacity, 0.54);
      transition: opacity 0.2s ease-in-out, color 0.2s ease-in-out;
    }

    .action-button:hover .action-icon,
    .action-icon:hover {
      color: var(--raml-headers-form-action-icon-color-hover, var(--secondary-button-color, var(--accent-color)));
      opacity: var(--raml-headers-form-action-icon-opacity-hover, 0.74);
    }

    [hidden] {
      display: none !important;
    }
    </style>
    <arc-definitions id="definitions"></arc-definitions>
    <iron-form>
      <form enctype="application/json">
        <dom-repeat items="{{model}}">
          <template>
            <div class="form-item">
              <span>
                <paper-checkbox class="enable-checkbox" checked="{{item.schema.enabled}}" title="Enable/disable this header"></paper-checkbox>
              </span>
              <api-headers-form-item name="{{item.name}}" value="{{item.value}}" model="[[item]]" required$="[[item.required]]" is-custom="[[item.isCustom]]" is-array="[[item.isArray]]" narrow="[[narrow]]"></api-headers-form-item>
              <span>
                <paper-icon-button title="Remove header" class="delete-icon" suffix icon="arc:remove-circle-outline" on-tap="_removeHeader"></paper-icon-button>
              </span>
            </div>
          </template>
        </dom-repeat>
      </form>
    </iron-form>
    <div class="add-action" hidden$="[[disallowCustom]]">
      <paper-button class="action-button" on-tap="add">
        <iron-icon class="action-icon" icon="arc:add-circle-outline"></iron-icon>
        Add custom header
      </paper-button>
    </div>
  </template>
  <script>
  /**
   * HTTP headers form build from AMF json/ld model.
   * The form is pre-populated with predefined values from the AMF model
   * using `api-view-model-transformer` element. This element is included in
   * `api-headers-editor`.
   *
   * **This API component replaces `raml-headers-form` component**. Old
   * component uses RAML data model generated by raml JS parser only.
   * If you need RAML form only or component that works with Polymer 1.0
   * use `raml-headers-form` instead.
   *
   * ## Building the view model
   *
   * For practical reasons this element consumes different data model than the
   * one used in AMF. Use `api-view-model-transformer` element to generate
   * data view model from AMF JSON ld schema. See demo page for example of
   * use.
   *
   * ### Generating view model from AMF
   *
   * ```html
   * <api-view-model-transformer on-view-model-changed="_updateView"></api-view-model-transformer>
   * <api-headers-form model="{{viewModel}}" value="{{headers}}"></api-headers-form>
   * <script>
   * const amfModel = getAmfFromRamlOrOas();
   * const processor = document.querySelector('api-view-model-transformer');
   * if (amfModel['@context']) {
   *  processor.amfContext = amfModel['@context'];
   * }
   * processor.amfModel = extractHeadersForMethod(amfModel);
   * processor.addEventListener('view-model-changed', (e) => {
   *  document.querySelector('api-headers-form') = e.detail.value;
   * });
   * < /script>
   * ```
   *
   * This example uses `getAmfFromRamlOrOas()` function where you implement
   * the logic of getting AMF json/ld data. It can be stored in file or parsed
   * using AMF parsers. The `extractHeadersForMethod()` function implements a
   * logic of extracting headers definition from a method (for example).
   *
   * ### Manually generating view model
   *
   * You can use `api-view-model-transformer` and `buildProperty()` function
   * to generate basic view model. You can also construct it on your own.
   * See `api-view-model-transformer` element documentation for model schema.
   *
   * ## Changes in v2
   *
   * * The component won't listen for `headers-value-changed` custom event.
   * Components / applications using this element should handle headers change
   * event in the application and generate new model for the view.
   * * Setting `value` makes no effect on the element. Only way to change
   * generated UI is to change the model.
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @appliesMixin Polymer.IronValidatableBehavior
   */
  class ApiHeadersForm extends Polymer.mixinBehaviors([
      Polymer.IronValidatableBehavior
    ], Polymer.Element) {

    static get is() {
      return 'api-headers-form';
    }
    static get properties() {
      return {
        /**
         * View model for the headers.
         */
        model: Array,
        /**
         * Current value of the headers. Changing the value will update the list
         * of the headers.
         */
        value: {
          type: String,
          notify: true
        },
        /**
         * If set, custom headers won't be available.
         */
        disallowCustom: Boolean,
        /**
         * If set it renders a narrow layout
         */
        narrow: Boolean
      };
    }

    static get observers() {
      return [
        '_modelChanged(model.*)'
      ];
    }
     /**
      * Handler for the remove button click.
      *
      * @param {CustomEvent} e
      */
    _removeHeader(e) {
      if (!e.model) {
        return;
      }
      const i = e.model.get('index');
      if (i < 0) {
        return;
      }
      this.splice('model', i, 1);
    }
    // Appends an empty header to the list.
    add() {
      if (this.disallowCustom) {
        return;
      }
      const obj = {
        value: '',
        name: '',
        isCustom: true,
        schema: {
          type: 'string'
        }
      };
      const ev = new CustomEvent('api-property-model-build', {
        detail: obj,
        cancelable: true,
        bubbles: true,
        composed: true
      });
      this.dispatchEvent(ev);
      if (!this.model) {
        this.set('model', [obj]);
      } else {
        this.push('model', obj);
      }
    }

    _modelChanged(record) {
      if (['model', 'model.splices'].indexOf(record.path) !== -1) {
        this._updateValue();
        if (record.path === 'model' && record.value) {
          this._autoDescribeModel(record.value);
        }
      } else if (record.path.match(/model.\d+.(name|value|schema\.enabled)/)) {
        this._updateValue();
      }
    }
    /**
     * Updates value of the element when model change.
     */
    _updateValue() {
      if (this.__updatingModelValue) {
        return;
      }
      this.__updatingModelValue = true;
      setTimeout(() => {
        // Prohibits computation when model is set.
        this.__updateValue();
        this.__updatingModelValue = false;
      }, 25);
    }
    /**
     * Creates a header value for current model.
     */
    __updateValue() {
      const h = this.model;
      if (!h || !h.length) {
        this.value = '';
        return;
      }
      const value = h.map((item) => {
        if (item.schema && item.schema.enabled === false) {
          return;
        }
        let n = item.name || '';
        let v = item.value || '';
        if (!n && !v) {
          return;
        }
        if (v instanceof Array) {
          v = v.join(',');
        }
        return n + ': ' + v;
      }).filter((item) => !!item).join('\n');
      this.set('value', value);
    }
    /**
     * Adds documentation for headers that doesn't have it already.
     *
     * @param {Array} model View model
     */
    _autoDescribeModel(model) {
      model.forEach((item, index) => this._fillModelDescription(item, index));
    }
    /**
     * Queries for header information and updates header info if needed.
     *
     * @param {Object} item View model item
     * @param {Number} index Position of the item in `model` array
     */
    _fillModelDescription(item, index) {
      if (item.hasDescription || item.isCustom) {
        return;
      }
      const type = this._queryHeaderData(item.name);
      if (!type) {
        return;
      }
      this.set(['model', index, 'description'], type.desc);
      this.set(['model', index, 'hasDescription'], true);
      this.set(['model', index, 'schema', 'examples'], [type.example]);
    }

    /**
     * Queries for a header definition.
     *
     * @param {String} name header name to query
     * @return {Object|undefined} Header definition or undefined.
     */
    _queryHeaderData(name) {
      const suggestions = this.$.definitions.queryHeaders(name, 'request');
      if (!suggestions) {
        return;
      }
      name = name.toLowerCase();
      return suggestions.find((i) => i.key.toLowerCase() === name);
    }
  }

  window.customElements.define(ApiHeadersForm.is, ApiHeadersForm);
  </script>
</dom-module>
